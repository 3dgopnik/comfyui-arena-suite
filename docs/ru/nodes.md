---
title: "Узлы"
description: "Справка по узлам ComfyUI Arena Suite."
---

[Обзор](index.md) · [Быстрый старт](quickstart.md) · [CLI](cli.md) · [Конфигурация](config.md) · [Диагностика](troubleshooting.md) · **Узлы**

---

# Узлы Arena AutoCache

Разделение по группам в ComfyUI:

## Basic
- ArenaAutoCache Analyze — автоанализ текущего воркфлоу, план копирования и автопрогрев без ввода.
- ArenaAutoCache Ops — сводный узел: аудит + прогрев (+trim при выборе режима).
- ArenaAutoCache Copy Status — визуальный индикатор статуса копирования моделей в реальном времени.

## Advanced
- ArenaAutoCache Dashboard — сводка и действия (настройки, аудит, trim) в одном месте.
- ArenaAutoCache Manager — быстрые изменения настроек и (опц.) trim.
- ArenaAutoCache Trim — принудительная очистка категории по LRU.
- ArenaAutoCache StatsEx — расширенная статистика с отдельными выходами.

## Utils
- ArenaGetActiveWorkflow — возвращает текущий активный воркфлоу (JSON) из PromptServer.
- ArenaAutoCache Stats — базовая статистика по кэшу (JSON).
- ArenaAutoCache Config — настройка кэша с поддержкой фильтров по размеру и путям.
- ArenaAutoCache Refresh Workflow — принудительное обновление активного workflow.

Примечание: точный состав узлов и выводы зависят от текущей версии. Подсказки по входам/выходам смотрите в интерфейсе ComfyUI или по всплывающим подсказкам.

## Workflow allowlist

Узлы Audit/Warmup/Ops перед запуском обновляют allowlist моделей на основе входов `items` и `workflow_json`. Если вход `workflow_json` пуст, узлы пытаются считать активный граф через `server.PromptServer` и продолжают работать с текущей схемой. Только перечисленные пары категория/файл попадают в LRU-копирование; прямые вызовы `folder_paths.get_full_path` без регистрации возвращают исходные пути без прогрева.

Fallback: если парсер ничего не нашёл в воркфлоу, используются последние сведения из статистики категории (`last_path`) — это позволяет прогреть последнюю использованную модель без ручных вводов.

## Фильтры копирования

AutoCache поддерживает два типа фильтров для оптимизации копирования:

### Фильтр по размеру
- **Параметр**: `min_size_gb` (по умолчанию: 1.0 ГБ)
- **Действие**: Модели размером меньше указанного порога пропускаются и остаются на исходном хранилище (например, NAS)
- **Цель**: Экономия места в SSD-кэше для крупных моделей, которые больше всего выигрывают от быстрого доступа

### Фильтр жёстко прописанных путей
- **Параметр**: `skip_hardcoded_paths` (по умолчанию: включён)
- **Действие**: Пропускает модели, которые жёстко привязаны к своим папкам и не работают в других местах
- **Паттерны**: ControlNet, InsightFace, IP-Adapter, CLIP Vision и модели в глубоко вложенных нестандартных структурах
- **Цель**: Избежать копирования моделей, которые всё равно не будут работать из кэша

### Настройка фильтров
Фильтры настраиваются через:
- **ArenaAutoCache Config** — интерактивная настройка в ComfyUI
- **Переменные окружения**:
  - `ARENA_CACHE_MIN_SIZE_GB=1.0` — минимальный размер для кэширования
  - `ARENA_CACHE_SKIP_HARDCODED=true` — пропускать жёстко прописанные пути

### Визуальный индикатор
**ArenaAutoCache Copy Status** отображает:
- Текущий статус копирования (активные задачи, завершённые, ошибки)
- Настройки фильтров
- Имя текущего копируемого файла
- Общую статистику операций

### Обновление workflow
**ArenaAutoCache Refresh Workflow** принудительно обновляет активный workflow:
- Очищает внутренний кеш workflow
- Сбрасывает список разрешенных моделей (allowlist)
- Заставляет ноды перечитать текущий workflow
- Показывает статус обновления и найденный workflow

## Уведомления о копировании

- `_copy_into_cache_lru` всегда отправляет события `copy_started`, `copy_completed` и `copy_skipped` в консоль (`[ArenaAutoCache] ...`) и, при наличии `PromptServer.instance`, синхронно ретранслирует их в канал `arena/autocache/copy_event`. События фиксируются даже при `ARENA_CACHE_VERBOSE=0`.
- В контексте ошибок отправляется событие `copy_failed` с текстом исключения, чтобы оверлей получил сигнал о проблеме.
- Узлы ArenaAutoCache Warmup и ArenaAutoCache Ops получили необязательный вход `log_context` (строка). Передайте текст или JSON с `node_id`, тегом пользователя и т.п. Строка автоматически оборачивается в `{"text": "..."}`.
- Warmup автоматически добавляет в контекст поле `node="ArenaAutoCacheWarmup"`, а Ops — `node="ArenaAutoCacheOps"` и `mode=<текущий режим>`. Итоговый контекст попадает во все события копирования, что позволяет ComfyUI overlay сопоставить прогрев с конкретным узлом и его выполнением.

